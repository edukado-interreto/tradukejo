{% extends 'wide-page.html' %}
{% load static i18n traduko_tags %}
{% block title %}{{ project.name }}{% endblock %}
{% block pagetitle %}
	{% if not project.visible %}<i class="fas fa-eye-slash mr-1" title="{% translate 'pages/projects#hidden' %}"></i>{% endif %}
	{% if project.locked %}<i class="fas fa-lock mr-1" title="{% translate 'pages/projects#locked' %}"></i>{% endif %}
	{{ project.name }}
{% endblock %}

{% block js %}
<script src="{% static 'traduko/js/project.js' %}"></script>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
	<ol class="breadcrumb main-breadcrumb">
		<li class="breadcrumb-item"><a href="{% url 'projects' %}">{% translate 'structure#home' %}</a></li>
		<li class="breadcrumb-item active" aria-current="page">{{ project.name }}</li>
	</ol>
</nav>


<div class="card mb-4">
	<div class="card-header">
		{{ project.name }}
	</div>
	<div class="row no-gutters">
		<div class="col">
			<div class="card-body">
				<p class="card-text">{{ project.description|linebreaks }}</p>
				{% if project.update_explanations %}
				<div class="alert alert-info">
					{{ project.update_explanations }}
				</div>
				{% endif %}
			</div>
		</div>
		<div class="col-md-4">
			<div class="card-body">
				<ul>
				{% if project.url %}
					<li>{% translate 'project#url' %} <a href="{{ project.url }}">{{ project.url }}</a></li>
				{% endif %}
					<li>{% translate 'project#source-language' %} {{ project.source_language.name }}</li>
					<li>{% translate 'project#strings' %} {{ project.strings }}</li>
					<li>{% translate 'project#words' %} {{ project.words }}</li>
					<li>{% translate 'project#characters' %} {{ project.characters }}</li>
					<li>
						{% translate 'project#needed' %}
						{% for l in project.needed_languages.all|dictsort:"name" %}<span lang="{{ l.code }}">{{ l.name }}</span>{% if not forloop.last %}, {% endif %}{% empty %}{% translate 'project#needed-all' %}{% endfor %}.
					</li>
				</ul>
			</div>
		</div>
		{% if project.image %}
		<div class="col-md-3 col-lg-2 order-first order-md-last">
			<div class="card-body text-right">
				<img src="{{ project.image.url }}" alt="" class="img-fluid d-block">
			</div>
		</div>
		{% endif %}
	</div>
	<div class="card-footer">
		{% url 'instructions' as url_instructions %}
		{% blocktranslate asvar readinstructions %}project#read-instructions{% endblocktranslate %}{% format_translation readinstructions url_instructions %}
	</div>
</div>

{% if is_project_admin %}
<div class="card mb-4 bg-secondary text-white project-admin-card">
	<div class="card-header">Administrado</div>
	<div class="card-body">
		<p class="text-center card-text">
			{% if user.is_superuser %}
				<a href="{% url 'admin:traduko_project_change' project.pk %}" class="btn btn-danger">Redakti en la administrejo</a>
			{% endif %}
			<a href="{% url 'edit_project' project.pk %}" class="btn btn-primary">Redakti la projekton</a>
			<a href="{% url 'translate' project.pk project.source_language.code %}" class="btn btn-success">Redakti la tekstojn</a>
			{% if translator_request_count > 0 %}
				<a href="{% url 'translator_request_list' project.pk %}" class="btn btn-warning"><strong>Petoj por traduki ({{ translator_request_count }})</strong></a>
			{% endif %}
			{% if show_translator_notifications_button %}
				<a href="{% url 'translator_notifications' project.pk %}" class="btn btn-primary">Sciigi la tradukantojn pri novaj tekstoj</a>
			{% endif %}
			<a href="{% url 'import_export' project.pk %}" class="btn btn-primary">Importi/eksporti</a>
		</p>
	</div>
</div>
{% endif %}

<div class="row">
	<div class="col-12 col-md-8 col-lg-9 col-xl-10">
		{% if my_languages_with_stats %}
		<h2>{% if is_project_admin %}{% translate 'project#languages' %}{% else %}{% translate 'project#my-languages' %}{% endif %}</h2>
		<div class="card my-4">
			{% include 'traduko/project/language-version-list.html' with language_versions=my_languages_with_stats can_translate=True %}
		</div>
		{% endif %}

		{% if available_languages_with_stats %}
		<h2>{% translate 'project#other-languages' %}</h2>
		<div class="card my-4">
			{% include 'traduko/project/language-version-list.html' with language_versions=available_languages_with_stats can_translate=False %}
		</div>
		{% endif %}

		{% if addible_languages and not project.locked or addible_languages and is_project_admin %}
		<h2>{% translate 'project#translate-other' %}</h2>
		<select name="addLanguage" id="addLanguage" class="select form-control mb-3">
			<option>{% translate 'project#choose-language' %}</option>
			{% for l in addible_languages %}
				<option lang="{{ l.code }}" dir="{{ l.direction }}"{% if is_project_admin %} data-url="{% url 'add_language_version' project.pk l.code %}"{% else %} data-code="{{ l.code }}" data-language="{{ l.name }}"{% endif %}>{{ l.code }} – {{ l.name }}</option>
			{% endfor %}
		</select>
		{% url 'contact' as url_contact %}
		{% blocktranslate asvar othercontact %}project#other-contact{% endblocktranslate %}{% format_translation othercontact url_contact %}
		{% endif %}
	</div>
	<div class="col">
		{% if last_comments %}
		<h2>{% translate 'project#last-comments' %}</h2>
		<div class="card mt-4">
			<div class="card-body last-activities">
				{% for date, comments in last_comments.items %}
				<h4>{{ date }}</h4>
				<ul>
					{% for comment in comments %}
					<li>
						{% ifchanged comment.trstringtext.language %}
							<b lang="{{ comment.trstringtext.language.code }}">{{ comment.trstringtext.language.name }}</b><br>
						{% endifchanged %}
						{% user_link comment.author.pk comment.author.username %}
						–
						{% if is_project_admin or comment.trstringtext.language in current_user_languages %}
							<a href="{% url 'translate' project.pk comment.trstringtext.language.code %}?dir={{ comment.trstringtext.trstring.path|urlencode }}#{{ comment.trstringtext.trstring.pk }}">
								{{ comment.trstringtext.trstring.path }}#{{ comment.trstringtext.trstring.name }}
							</a>
						{% elif comment.trstringtext.language == project.source_language and current_user_languages %}
							{% with current_user_languages|list_index:0 as lang %}
							<a href="{% url 'translate' project.pk lang.code %}?dir={{ comment.trstringtext.trstring.path|urlencode }}#{{ comment.trstringtext.trstring.pk }}">
								{{ comment.trstringtext.trstring.path }}#{{ comment.trstringtext.trstring.name }}
							</a>
							{% endwith %}
						{% else %}
							{{ comment.trstringtext.trstring.path }}#{{ comment.trstringtext.trstring.name }}
						{% endif %}
					</li>
					{% endfor %}
				</ul>
				{% endfor %}
			</div>
		</div>
		{% endif %}
		<h2>{% translate 'project#last-activities' %}</h2>
		<div class="card mt-4">
			<div class="card-body last-activities">
				{% for date, activities in last_activities.items %}
				<h4>{{ date }}</h4>
				<ul>
					{% for activity in activities %}
					<li>
						{% ifchanged activity.language__code %}
							<b lang="{{ activity.language__code }}">{{ activity.language__name }}</b><br>
						{% endifchanged %}
						{% user_link activity.user__pk activity.user__username as t_user_link %}
						{% if activity.action == ACTION_TYPE_TRANSLATE %}
							{% blocktranslate trimmed asvar translated count counter=activity.words_sum %}
								project#translated-words
								{% plural %}
								project#translated-words
							{% endblocktranslate %}
							{% format_translation translated t_user_link activity.words_sum %}
						{% elif activity.action == ACTION_TYPE_EDIT %}
							{% blocktranslate trimmed asvar edited count counter=activity.strings %}
								project#edited-strings
								{% plural %}
								project#edited-strings
							{% endblocktranslate %}
							{% format_translation edited t_user_link activity.strings %}
						{% elif activity.action == ACTION_TYPE_ADD %}
							{% blocktranslate trimmed asvar added count counter=activity.words_sum %}
								project#added-words
								{% plural %}
								project#added-words
							{% endblocktranslate %}
							{% format_translation added t_user_link activity.words_sum %}
						{% elif activity.action == ACTION_TYPE_IMPORT %}
							{% blocktranslate trimmed asvar imported count counter=activity.words_sum %}
								project#imported-words
								{% plural %}
								project#imported-words
							{% endblocktranslate %}
							{% format_translation imported t_user_link activity.words_sum %}
						{% endif %}
					</li>
					{% endfor %}
				</ul>
				{% endfor %}
			</div>
		</div>
	</div>
</div>

{% if not is_project_admin and not project.locked %}
<div class="modal fade" id="translatorRequestModal" tabindex="-1" aria-labelledby="translatorRequestModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form action="{% url 'request_translator_permission' project.pk %}" method="post">
				<div class="modal-header">
					<h5 class="modal-title" id="translatorRequestModalLabel">{% translate 'project#request-permission' context 'Titolo de fenestreto' %}</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Fermi">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p id="requestResult"></p>
					<div class="form-group" id="requestFields">
						{% csrf_token %}
						<p>{% translate 'project#request-language' %} <strong><span id="requestLanguageName">xx</span> (<span id="requestLanguageCode">xx</span>)</strong>.</p>
						<label for="explanation">{% translate 'project#request-explanation' %}</label>
						<textarea name="explanation" id="explanation" rows="6" class="form-control" required></textarea>
					</div>
					<input type="hidden" name="language" id="requestLanguageCodeInput">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">{% translate 'structure#close' %}</button>
					<input type="submit" class="btn btn-primary" value="{% translate 'project#sendi' context 'Butono por sendi peton pri tradukpermeso' %}" id="requestSubmit">
				</div>
			</form>
		</div>
	</div>
</div>
{% endif %}

{% endblock %}

